# グラフで考える

<https://graphql.org/learn/thinking-in-graphs/>

- [グラフで考える](#グラフで考える)
  - [どこまでもグラフ(It's Graphs All the Way Down)](#どこまでもグラフits-graphs-all-the-way-down)
  - [言語の共有](#言語の共有)
  - [ビジネスロジックレイヤ](#ビジネスロジックレイヤ)
  - [遺産(Legacy)となったデータと機能する](#遺産legacyとなったデータと機能する)
  - [1度に1ステップ](#1度に1ステップ)

## どこまでもグラフ(It's Graphs All the Way Down)

> GraphQLを使用すると、グラフとしてビジネスドメインをモデル化します。

グラフは、自然で精神的なモデルと根底にある言葉による説明に似ているため、グラフは多くの現実世界の現象をモデリングする強力なツールです。
GraphQLを使用すると、スキーマを定義することにより、ビジネスドメインをモデルとしてモデル化します。
スキーマ内で様々な種類のノードと、それらがほかとどのように接続するかまたは関係するかを定義します。
クライアント上では、これはオブジェクト指向プログラミングに似たパターンを作り、型は他の型を参照します。
サーバー上では、GraphQLはインターフェイスのみを定義するため、新しいまたは古い任意のバックエンドでそれを自由に使用できます。

## 言語の共有

> 名前を付けることは難しいが、直感的なAPIを構築する重要な部分です。

GraphQLスキーマを、チームとユーザーで共有する言語として表現するように検討してください。
良いスキーマを構築するために、毎日ビジネスを説明するために使用する言語を試験してください。
例えば、英語の平文でEメールアプリを説明してみましょう。

- ユーザーは複数のEメールアカウントを持てます。
- それぞれのEメールアカウントはアドレス、受信箱、ドラフト、削除されたアイテム、そして送信したアイテムを持ちます。
- それぞれのEメールは、送信者、受診した日、表題、そして本文を持ちます。
- ユーザーは受信者のアドレスなしでEメールを送信できません。

名前を付けることは難しいですが、直感的なAPIを構築する重要な部分であるため、問題となっているドメインとユーザーにとって意味をなすように注意深く考える時間を取ってください。
直感的で永続的なノードと関連の名前をGraphQLスキーマ内で選択する必要があるため、チームは共有され理解と総意を得たこれらのビジネスドメインルールを開発するべきです。
実行したいクエリをいくつか想像してみましょう。

すべてのアカウントの受信ボックスにある読んでいないEメールの数を取得します。

```graphql
{
  accounts {
    inbox {
      unreadEmailCount
    }
  }
}
```

メインアカウントにある最初の20通のドラフトの"プレビュー情報"を取得します。

```graphql
{
  mainAccount {
    drafts(first: 20) {
      ...previewInfo
    }
  }
}

fragment previewInfo on Email {
  subject
  bodyPreviewSentence
}
```

## ビジネスロジックレイヤ

> ビジネスロジックレイヤは、ビジネスドメインルールを強制するために、唯一の真実の情報源として機能するべきです。

実際にビジネスロジックはどこに定義するべきでしょうか？
検証と認証確認はどこで実行するべきでしょうか？
答え: 献身的なビジネスロジックレイヤの中です。
ビジネスロジックレイヤは、ビジネスドメインルールを強制するために、唯一の真実の情報源として機能するべきです。

![アプリケーションレイヤの階層](https://graphql.org/nextImageExportOptimizer/business_layer.68bf746f-opt-640.WEBP)

上記図において、システムに入るREST、GraphQLそしてRPCのエントリポイントは同様の検証、認証そしてエラー処理ルールを処理します。

## 遺産(Legacy)となったデータと機能する

> 遺産となったデータベースのスキーマを鏡写しするよりも、どのようにクライアントがデータを使用する方法を説明するGraphQLスキーマを構築することが望ましいです。

時々、クライアントがデータを消費する方法を完全に反映できない遺産となったデータソースで作業していることに気付くことがあります。
この場合、遺産となったデータベーススキーマを鏡写しするよりも、クライアントがデータを使用する方法を説明するGraphQLスキーマを構築することが望ましいです。

"何を"よりも"どのように"を表現するGraphQLスキーマを構築してください。
すると、過去のクライアントのインターフェイスを破ることなく、実装の詳細を改善できます。

## 1度に1ステップ

> より頻繁に検証とフィードバックを得てください。

一気にビジネスドメイン全体をモデルしないでください。
むしろ、1度で1つのシナリオに必要となるスキーマの部分だけを構築してください。
徐々にスキーマを拡大することで、適切なソリューションの構築に向かって進むために、より頻繁に検証とフィードバックを得られます。

1. [どこまでも亀(Turtles all the way down)](https://en.wikipedia.org/wiki/Turtles_all_the_way_down)は、無限に交代する問題を表現しています。
